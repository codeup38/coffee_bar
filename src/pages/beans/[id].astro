---
import Layout from "../../components/Layout.astro";
import OrderForm from "../../components/OrderForm.astro";
import beans from "../../data/beans.json";

export function getStaticPaths() {
  return beans.map((bean) => ({
    params: { id: bean.id },
    props: { bean }
  }));
}

const { bean } = Astro.props;

const profileItems = [
  { label: "산미", value: bean.profile.acidity },
  { label: "단맛", value: bean.profile.sweetness },
  { label: "바디", value: bean.profile.body }
];
---

<Layout title={`${bean.name} · coffee bar`} description={bean.one_liner}>
  <div data-bean-page data-bean-id={bean.id}>

    <!-- Header card — always visible -->
    <section class="sticker-card">
      <p class="sticker-chip inline-flex">{bean.badge}</p>
      <h1 class="mt-3 text-3xl font-bold text-roast sm:text-4xl">{bean.name}</h1>
      <p class="mt-2 text-base text-ink/90">{bean.one_liner}</p>
      <p class="mt-3 text-sm text-ink/90">{bean.intro[0]}</p>

      <dl class="mt-4 space-y-2">
        {
          profileItems.map((item) => (
            <div class="grid grid-cols-[45px_1fr_40px] items-center gap-2 text-sm">
              <dt class="font-bold text-roast">{item.label}</dt>
              <dd class="taste-meter">
                {Array.from({ length: 5 }).map((_, index) => <span class={index < item.value ? "is-active" : ""} />)}
              </dd>
              <dd class="text-right text-xs text-ink/70">{item.value}/5</dd>
            </div>
          ))
        }
      </dl>
    </section>

    <!-- PRE-ORDER: order form + story -->
    <div class="bean-pre-order">
      <OrderForm bean={bean} pagePath={`/beans/${bean.id}`} />

      {bean.intro.length > 1 && (
        <section class="sticker-card mt-6">
          <h2 class="text-2xl font-bold text-roast">이 원두의 이야기</h2>
          <div class="mt-3 space-y-3 text-sm text-ink/90">
            {bean.intro.slice(1).map((paragraph) => <p>{paragraph}</p>)}
          </div>
        </section>
      )}

      <div class="mt-6 text-center">
        <a href="/beans" class="text-sm font-bold text-roast underline decoration-roast/40 underline-offset-4">다른 원두 보기</a>
      </div>
    </div>

    <!-- POST-ORDER: reading content -->
    <div class="bean-post-order">
      <section class="sticker-card mt-6 text-center">
        <p class="sticker-chip inline-flex">ORDER RECEIVED</p>
        <p class="mt-3 text-sm text-ink/85">
          주문이 접수되었습니다.<br/>기다리면서 원두 이야기를 읽어보세요.
        </p>
      </section>

      <section class="sticker-card mt-6" id="bean-reading">
        {bean.intro.length > 1 && (
          <div>
            <h2 class="text-2xl font-bold text-roast">이 원두의 이야기</h2>
            <div class="mt-3 space-y-3 text-sm text-ink/90">
              {bean.intro.slice(1).map((p) => <p>{p}</p>)}
            </div>
          </div>
        )}

        <div class="mt-6 border-t border-roast/10 pt-5">
          <h2 class="text-2xl font-bold text-roast">마실 때 포인트</h2>
          <p class="mt-2 text-sm text-ink/90">{bean.drink_tip}</p>
        </div>

        <div class="mt-6 border-t border-roast/10 pt-5">
          <h2 class="text-2xl font-bold text-roast">더 알아보기</h2>
          <div class="mt-3 space-y-3 text-sm text-ink/90">
            {bean.background.map((p) => <p>{p}</p>)}
          </div>
        </div>
      </section>

      <div class="mt-6 text-center">
        <a href="/beans" class="text-sm font-bold text-roast underline decoration-roast/40 underline-offset-4">다른 원두 보기</a>
      </div>
    </div>

  </div>

  <script is:inline>
    (() => {
      const page = document.querySelector("[data-bean-page]");
      if (!page) return;
      const params = new URLSearchParams(window.location.search);
      const hasReadingParam = params.has("reading");
      if (hasReadingParam) {
        page.classList.add("bean-ordered");
        document.getElementById("bean-reading")?.scrollIntoView({ behavior: "smooth", block: "start" });
      }
    })();
  </script>
</Layout>
