---
const { title = "QR 코드", targetPath = "/" } = Astro.props;
---

<section class="sticker-card" data-qr-panel data-target-path={targetPath}>
  <h2 class="text-2xl font-bold text-roast">{title}</h2>
  <p class="mt-2 text-sm text-ink/85">화면에 보이는 QR을 스캔해 주세요.</p>

  <div class="mt-5 flex justify-center">
    <canvas
      data-qr-canvas
      width="280"
      height="280"
      class="rounded-2xl border border-roast/20 bg-white p-3 shadow-sticker"
    ></canvas>
  </div>

  <p class="mt-4 break-all rounded-xl bg-paper px-3 py-2 text-xs text-ink/85" data-share-url>
    URL 생성 중...
  </p>

  <div class="mt-3 grid gap-2 sm:grid-cols-2">
    <button
      type="button"
      class="touch-target rounded-xl border border-roast/30 bg-white px-4 py-2.5 text-sm font-bold text-roast"
      data-copy-url
    >
      URL 복사
    </button>
    <button
      type="button"
      class="touch-target rounded-xl bg-roast px-4 py-2.5 text-sm font-bold text-paper"
      data-web-share
    >
      공유하기
    </button>
  </div>

  <p class="mt-2 text-xs text-ink/70" data-share-feedback></p>

  <noscript>
    <p class="mt-4 rounded-xl bg-paper px-3 py-2 text-xs text-ink/75">
      JavaScript가 꺼져 있어 QR이 표시되지 않습니다. 메인 주소를 직접 공유해 주세요.
    </p>
  </noscript>
</section>

<script>
  import QRCode from "qrcode";

  document.querySelectorAll("[data-qr-panel]").forEach((panel) => {
    const targetPath = panel.dataset.targetPath || "/";
    const shareUrl = new URL(targetPath, window.location.origin).toString();

    const canvas = panel.querySelector("[data-qr-canvas]");
    const urlLabel = panel.querySelector("[data-share-url]");
    const copyButton = panel.querySelector("[data-copy-url]");
    const shareButton = panel.querySelector("[data-web-share]");
    const feedback = panel.querySelector("[data-share-feedback]");

    if (urlLabel) {
      urlLabel.textContent = shareUrl;
    }

    if (canvas instanceof HTMLCanvasElement) {
      QRCode.toCanvas(canvas, shareUrl, {
        width: 280,
        margin: 1,
        color: {
          dark: "#2a1e16",
          light: "#fffdf9"
        }
      }).catch(() => {
        if (feedback) {
          feedback.textContent = "QR 생성에 실패했습니다. 아래 URL을 직접 공유해 주세요.";
        }
      });
    }

    if (copyButton) {
      copyButton.addEventListener("click", async () => {
        if (!navigator.clipboard) {
          if (feedback) {
            feedback.textContent = "이 환경에서는 클립보드 복사가 지원되지 않습니다.";
          }
          return;
        }

        try {
          await navigator.clipboard.writeText(shareUrl);
          if (feedback) {
            feedback.textContent = "URL을 복사했습니다.";
          }
        } catch {
          if (feedback) {
            feedback.textContent = "복사에 실패했습니다. URL을 길게 눌러 복사해 주세요.";
          }
        }
      });
    }

    if (shareButton) {
      if (!navigator.share) {
        shareButton.hidden = true;
      } else {
        shareButton.addEventListener("click", async () => {
          try {
            await navigator.share({
              title: "coffee bar",
              text: "명절 팝업 커피바 메뉴입니다. 원두 골라서 주문해 보세요!",
              url: shareUrl
            });
          } catch {
            // 사용자가 취소한 경우 무시
          }
        });
      }
    }
  });
</script>
